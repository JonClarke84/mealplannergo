<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meal Planner with HTMX</title>
    <link rel="stylesheet" href="public/css/index.css">
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {}
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold">Meal Planner</h1>
        <ul>
            {{ range .MealPlan }}
            {{ block "meal-input" . }}
            <li class="relative mt-6" id="{{.Day}}-container">
                <label
                    for="{{.Day}}-input"
                    class="relative block rounded-md border border-gray-200 shadow-sm focus-within:border-blue-600 focus-within:ring-1 focus-within:ring-blue-600"
                >
                    <input
                    type="text"
                    name="{{.Day}}"
                    id="{{.Day}}-input"
                    value="{{.Meal}}"
                    placeholder="Start typing..."
                    class="w-full peer border-none bg-transparent placeholder-transparent focus:border-transparent focus:outline-none focus:ring-0"
                    hx-post="/meal"
                    hx-trigger="keyup changed delay:1s"
                    hx-target="#{{.Day}}-container"
                    />
                    <span
                    class="pointer-events-none absolute start-2.5 top-0 -translate-y-1/2 p-0.5 text-xs text-gray-700 transition-all peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-0 peer-focus:text-xs"
                    >
                        {{.Day}}
                    </span>
                </label>
                {{ end }}
            </li>
            {{ end }}
        </ul>
         <h2 class="text-2xl font-bold m-4">Shopping List</h2>
        <div>
            <form
                id="shopping-list-form"
                hx-post="/shopping-list"
                hx-target="#shopping-list"
                hx-swap="beforeend"
            >
                <div
                    style="display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 5px;
                    background: #ffffff;
                    border: 1px solid #ddd;
                    padding: 8px;
                    margin-bottom: 8px;"
                >
                    <input
                        type="text"
                        id="shopping-list-input"
                        name="item"
                        style="flex-grow: 1;"
                        placeholder="Start typing..."
                    />
                    <button type="submit">‚ûï</button>
                </div>
            </form>
        </div>
        {{ block "shopping-list" . }}
        <ul
        id="shopping-list"
        class="sortable"
        hx-include="this"
        hx-swap="outerHTML"
        hx-post="/shopping-list/sort"
        hx-trigger="end"
        >
                {{ range .ShoppingList }}
                {{ block "shopping-list-item" . }}
                    <li name="list" value="{{.}}">
                        <form
                            hx-put="/shopping-list?shopping-list-item={{.}}"
                            hx-swap="outerHTML"
                            hx-target="closest li"
                        >
                            <div class="mt-2">
                                <label
                                    for="{{.}}"
                                    class="flex items-center cursor-pointer items-start gap-4 rounded-lg border border-gray-200 p-2 bg-white transition hover:bg-gray-50"
                                >
                                    <div class="flex items-center">
                                        &#8203;
                                        <input type="checkbox" class="size-4 rounded border-gray-300" id="{{.}}" />
                                    </div>
                                    <input
                                        name="item"
                                        type="text"
                                        id="item-{{.}}"
                                        value="{{.}}"
                                        class="mt-1 w-full rounded-md border-gray-200 shadow-sm sm:text-sm"
                                    />
                                    <button
                                        type="submit"
                                    >üíæ</button>
                                    <button
                                        hx-delete="/shopping-list?shopping-list-item={{.}}"
                                        hx-trigger="click"
                                        hx-target="closest li"
                                        hx-swap="outerHTML"
                                    >‚ùå</button>
                                </label>
                            </div>
                        </form>
                    </li>
                {{ end }}
                {{ end }}
            {{ end }}
            </ul>
    </div>
    <script src="public/htmx.min.js"></script>
    <!-- jsDelivr :: Sortable :: Latest (https://www.jsdelivr.com/package/npm/sortablejs) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        function initializeSortable() {
            var sortables = document.querySelectorAll(".sortable");
            sortables.forEach(function(sortable) {
                new Sortable(sortable, {
                    animation: 150,
                    ghostClass: 'drag-ghost-class',
                    dragClass: 'li-drag-class',
                    filter: ".htmx-indicator",
                    forceFallback: true,
                    onMove: function(evt) {
                        return evt.related.className.indexOf('htmx-indicator') === -1;
                    }
                });
            });
        }

        // Run on initial page load
        initializeSortable();

        // Re-run whenever HTMX swaps in new content
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'shopping-list') {
                initializeSortable();
            }
        });
    </script>
</body>
</html>
